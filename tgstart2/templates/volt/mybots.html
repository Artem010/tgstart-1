{% extends 'baselk.html' %}
{% load static %}
{% block title %}Мои боты{% endblock %}
{% block head%}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
{%endblock%}
{%block mainContent%}
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2 theme zag">Мои боты</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <button type="button" class="btn  theme nav-link1" data-toggle="modal" data-target="#exampleModal">
            Создать Бота
          </button>
        </div>
      </div>
      <div class="modal fade " id="exampleModal"    aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-body">
              <a href="#close" title="Close" data-dismiss="modal" aria-label="Close" class="close nav-link1">×</a>
              <h3 class="modal-title zag">Создание бота</h3>
              <div class="razdel">
              </div>
              <div class="theme name1" >
                Для начала необходимо создать бота в <a class=" nav-link1" style="font-size: 1em" href="https://t.me/botfather">BotFather</a><br>
                Напишите боту команду /newbot и следуйте инструкциям.<br>
                Скопируйте полученный токен и вставьте в поле ниже.<br>
                Для редактирования ответов своего бота, перейдите во вкладку "Мои боты" и нажмите на значок    <i class="fa fa-pencil" aria-hidden="true"></i>   у выбранного бота.
              </div>
              <div class="razdel">
              </div>
              <form id="formCreateBot" class=""  method="post">
                {% csrf_token %}
                <div class="form-group mb-2">
                  <label class="errorLine"></label><br>
                  <input class="tgToketnInput form-control" autocomplete="off" type="text" name="tgToken" id="tgToken" value="">
                </div>

                <div class="form-check" style="display: none;">
                  <input class="form-check-input" type="radio" name="option" id="option2" value="option2" checked>
                  <label class="form-check-label" for="option2">Командир</label>
                </div>
                  <input type="button" disabled value="Создать бота" class="createBot btn  theme nav-link1"></input>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% if bots%}
      <div class="container">
        <div class="row justify-content-center">
          {%for i in bots %}
          <div class="inf-card" style="width: 20rem; margin:1rem;">
            <div class="text-center ">
              <h5 class="bot-card-name">{{i.bot_name}}</h5>
            </div>
            {%if i.status == 1%}
              <h5 class="text-success "> Статус: Активно</h5>
            {%else%}
              <h5 class="text-danger "> Статус: Неактивно<h5>
            {% endif %}
              <a href="https://t.me/{{i.bot_username}}" class="nav-link1">{{i.bot_username}}</a><br>
              <div class="bot-settings text-center">
                <a href='/mybots/edit' data-id='{{i.id}}' style="font-size:2em" class="nav-link1"><i class="fa fa-pencil" aria-hidden="true"></i></a>
                <a href="/mybots/removebot" data-id='{{i.id}}' style="font-size:2em; color:red!important;" class="nav-link1"><i class="fa fa-ban" aria-hidden="true"></i></a>
                {%if i.status == 1%}
                  <a href="/mybots/deactivatebot" style="font-size:2em" data-id='{{i.id}}' class=" nav-link1"><i class="fa fa-toggle-on" aria-hidden="true"></i></a>
                {%else%}
                  <a href="/mybots/activatebot" style="font-size:2em" data-id='{{i.id}}' class="nav-link1"><i class="fa fa-toggle-off" aria-hidden="true"></i></a>
                {%endif%}
              </div>
          </div>

          {%endfor%}
        </div>

      </div>
      {%else%}
      <h2 class="zag">У вас ещё нет ботов, нажмите кнопку "Создать бота"</h2>
      {%endif%}
      <script>
        $('.tgToketnInput').on('input', function(){
        let val = $(this).val();
        if(val.includes(':')) {
          $('.createBot').removeAttr('disabled');
          $('.errorLine').text('').css('color', 'red');
        } else {
          $('.errorLine').text('Невалидный бот-токен').css('color', 'red');
          $('.createBot').attr('disabled', true);
        }
      });


      $('.editLink').click(function(){
        // let a = $(this).data('bid')
        let data = 'csrfmiddlewaretoken='+$("input[name='csrfmiddlewaretoken']").val()+'&botID='+$(this).data('id')
        console.log(data)
        $.ajax({
          url: '', // путь к php-обработчику
          type: 'POST', // метод передачи данных
          dataType: 'html', // тип ожидаемых данных в ответе
          data: data, // данные, которые передаем на сервер
          // error: function(req, text, error){ // отслеживание ошибок во время выполнения ajax-запроса
          //   alert('Хьюстон, У нас проблемы! ' + text + ' | ' + error);
          // },
          success: function(d){
            $('.errorLine').text(d).css('color', 'red');
          }
        });
      });

      $('.createBot').click(function(){
        // let a = $(this).data('bid')
        // let data = 'csrfmiddlewaretoken='+$("input[name='csrfmiddlewaretoken']").val()+'&botID='+$(this).data('id')


        $.ajax({
          url: '', // путь к php-обработчику
          type: 'POST', // метод передачи данных
          dataType: 'html', // тип ожидаемых данных в ответе
          data: $("#formCreateBot").serialize(), // данные, которые передаем на сервер
          // error: function(req, text, error){ // отслеживание ошибок во время выполнения ajax-запроса
          //   alert('Хьюстон, У нас проблемы! ' + text + ' | ' + error);
          // },
          success: function(d){
            $('.errorLine').text(d).css('color', 'red');
          }
        });
      });

      </script>

    </main>
{%endblock%}
